####################################################################################################################
###
### Replicate survival
###
####################################################################################################################

#This will be the survival code implemented into main when it is working and generalized for now, I will try to get it to work on one case.

from lifelines import CoxPHFitter
import csv
import pandas as pd
import numpy as np



def runcph(coxdf, dur, eve):
    coxdf = pd.DataFrame(coxdf).T
    cph = CoxPHFitter()
    cph.fit(coxdf, duration_col = dur, event_col = eve, show_progress=True)  
    return cph

p1 = pd.read_csv('C:/Users/rschult4/Dropbox (ASU)/PanCancer/Reconstructed pData/GSE49278_pData_recon.csv',header = 0,index_col = 0)
coxdf = []


# Run if there is any survival info availible
luvta = lambda x: not x
if any(pd.isnull(p1['OS.STATUS']).apply(luvta)) and any(pd.isnull(p1['OS.TIME']).apply(luvta)) or any(pd.isnull(p1['PFS.STATUS']).apply(luvta)) and any(pd.isnull(p1['PFS.TIME']).apply(luvta)):
    # Run if the info availible is Overall Survival
    if any(pd.isnull(p1['OS.STATUS']).apply(luvta)) and any(pd.isnull(p1['OS.STATUS']).apply(luvta)):
        coxdf.append(p1['OS.STATUS'])
        coxdf.append(p1['OS.TIME'])
        dur = 'OS.TIME'
        eve = 'OS.STATUS' 
        surv=runcph(coxdf, dur, eve)
    
    # Run if there is also age information
    if any(pd.isnull(p1['AGE']).apply(luvta)):
        coxdf.append(p1['AGE'])
        survA=runcph(coxdf, dur, eve)
        # Run if there is also sex information
        if any(pd.isnull(p1['SEX']).apply(luvta)):
            coxdf.append(pd.get_dummies(p1['SEX'])['M']) # Male is 1 and female is 0
            survAS=runcph(coxdf, dur, eve)
            
    """# If there is no Overall Survival, use Progression Free Survival
    if any(pd.isnull(p1['PFS.STATUS']).apply(luvta)) and any(pd.isnull(p1['PFS.TIME']).apply(luvta)):
        coxdf.append(p1['PFS.STATUS'])
        coxdf.append(p1['PFS.TIME'])
        dur = 'PFS.TIME'
        eve = 'PFS.STATUS'
        surv=runcph(coxdf, dur, eve)
    """
else:
    print("No Survival!")
    

